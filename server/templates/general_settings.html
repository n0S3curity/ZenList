<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הגדרות כלליות</title>
    <!-- Tailwind CSS CDN -->
    <link rel="icon"
          href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234f46e5'><path d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar and other styles from receipts.html */
        .sidebar {
            width: 250px;
            background-color: #1f2937;
            color: #d1d5db;
            padding: 1.5rem;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            right: -250px;
            height: 100%;
            transition: right 0.3s ease-in-out;
            z-index: 2000;
        }
        .sidebar.open {
            right: 0;
        }
        @media (min-width: 768px) {
            .sidebar {
                position: relative;
                right: 0;
                flex-shrink: 0;
            }
        }

        .main-content {
            flex-grow: 1;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 0;
            transition: margin-right 0.3s ease-in-out;
        }
        @media (min-width: 768px) {
            .main-content {
                padding: 1.5rem;
                margin-right: 250px;
            }
        }

        .container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1rem;
        }
        @media (min-width: 768px) {
            .container {
                padding: 2rem;
            }
        }

        .main-title {
            font-size: 1.75rem;
        }
        @media (min-width: 768px) {
            .main-title {
                font-size: 3rem;
            }
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 2rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background-color: #10b981;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 5000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateY(20px);
        }
        .success-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Hamburger menu icon */
        .hamburger-icon {
            display: block;
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 3000;
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        @media (min-width: 768px) {
            .hamburger-icon {
                display: none;
            }
        }

        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 4000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 1rem;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .custom-dropdown-options {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            background-color: white;
            position: absolute;
            width: 100%;
            z-index: 1000;
        }

        .custom-dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }

        .custom-dropdown-item:last-child {
            border-bottom: none;
        }

        .custom-dropdown-item:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100">
<!-- Hamburger Menu Icon for Mobile -->
<div id="hamburgerIcon" class="hamburger-icon">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
</div>
{% include 'sidebar.html' %}
<!-- Main Content Area -->
<div class="main-content">
    <div class="container">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center main-title">הגדרות כלליות</h1>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="loading-spinner"></div>

        <!-- Content Area for settings -->
        <div id="settingsContent" class="space-y-6">
            <!-- Supermarket settings will be rendered here by JavaScript -->
        </div>
        <!-- Action button at the bottom of the main content -->
        <div class="flex justify-center mt-6">
            <button id="updateBtn"
                    class="flex-shrink-0 bg-green-500 text-white rounded-lg p-3 transition-colors hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                עדכן מחירים
            </button>
        </div>
    </div>
</div>
</div>

<!-- Toast Notification -->
<div id="toastNotification" class="success-toast">
    ההגדרות נשמרו בהצלחה!
</div>

<!-- Modal for displaying store details -->
<div id="detailsModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3 id="modalStoreName" class="text-2xl font-bold text-gray-800 mb-2"></h3>
        <p class="text-gray-600 mb-2"><strong>כתובת:</strong> <span id="modalAddress"></span></p>
        <p class="text-gray-600 mb-4"><strong>עיר:</strong> <span id="modalCity"></span></p>
        <div id="modal-map-container" class="w-full h-64 mt-4 rounded-lg overflow-hidden border border-gray-300"></div>
        <div class="flex justify-center mt-6">
            <button id="addFromModalBtn"
                    class="flex-shrink-0 bg-green-500 text-white rounded-lg p-3 transition-colors hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                הוסף לחנויות המועדפות
            </button>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', () => {
        const loadingSpinner = document.getElementById('loadingSpinner');
        const settingsContent = document.getElementById('settingsContent');
        const toastNotification = document.getElementById('toastNotification');
        const hamburgerIcon = document.getElementById('hamburgerIcon');
        const sidebar = document.getElementById('sidebar');

        const detailsModal = document.getElementById('detailsModal');
        const closeModalBtn = detailsModal.querySelector('.close-btn');
        const addFromModalBtn = document.getElementById('addFromModalBtn');

        let allAvailableStores = [];
        let likedStores = [];

        const hebrewBrandNames = {
            'osherad': 'אושר עד',
            'yohananof': 'יוחננוף'
        };

        function showLoading() {
            loadingSpinner.style.display = 'block';
            settingsContent.classList.add('hidden');
        }

        function hideLoading() {
            loadingSpinner.style.display = 'none';
            settingsContent.classList.remove('hidden');
        }

        function showToast(message = 'ההגדרות נשמרו בהצלחה!') {
            toastNotification.textContent = message;
            toastNotification.classList.add('show');
            setTimeout(() => {
                toastNotification.classList.remove('show');
            }, 3000);
        }

        hamburgerIcon.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        closeModalBtn.addEventListener('click', () => {
            detailsModal.classList.add('hidden');
        });

        window.addEventListener('click', (event) => {
            if (event.target === detailsModal) {
                detailsModal.classList.add('hidden');
            }
        });

        async function fetchSettings() {
            showLoading();
            try {
                const response = await fetch('/api/generalSettings');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                likedStores = Object.entries(data.supermarkets.liked).flatMap(([brand, stores]) =>
                    stores.map(store => ({ ...store, brandName: brand }))
                );

                allAvailableStores = Object.entries(data.supermarkets.available).flatMap(([brand, stores]) =>
                    stores.map(store => ({ ...store, brandName: brand }))
                );

                renderSettings(likedStores, allAvailableStores);
            } catch (error) {
                console.error('Error fetching settings:', error);
                settingsContent.innerHTML = '<p class="text-red-500 text-center">אירעה שגיאה בטעינת ההגדרות.</p>';
            } finally {
                hideLoading();
            }
        }

        async function updateLikedSupermarket(storeId, brandName, action) {
            showLoading();
            try {
                const url = `/api/generalSettings/${action}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ StoreId: storeId, brandName: brandName })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                await fetchSettings();
                showToast(`ההגדרות עודכנו בהצלחה.`);
            } catch (error) {
                console.error(`Error ${action}ing store:`, error);
                showToast(`אירעה שגיאה בעדכון ההגדרות.`);
            } finally {
                hideLoading();
            }
        }

        function renderSettings(likedStores, allAvailableStores) {
            settingsContent.innerHTML = '';

            const likedSection = document.createElement('div');
            likedSection.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-700 mb-4">חנויות מועדפות</h2>
                <div id="likedStores" class="space-y-4"></div>
            `;
            settingsContent.appendChild(likedSection);
            const likedStoresContainer = likedSection.querySelector('#likedStores');

            likedStores.forEach(store => {
                likedStoresContainer.appendChild(createLikedStoreElement(store));
            });

            const availableSection = document.createElement('div');
            availableSection.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-700 mb-4 mt-8">הוספת חנות</h2>
                <div class="flex flex-col md:flex-row gap-4 items-end">
                    <div class="flex-grow w-full md:w-auto relative">
                        <input type="text" id="storeFilterInput" placeholder="הקלד לסינון..." class="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-shadow">
                        <div id="availableStoresOptions" class="custom-dropdown-options hidden"></div>
                    </div>
                </div>
            `;
            settingsContent.appendChild(availableSection);

            const storeFilterInput = document.getElementById('storeFilterInput');
            const availableStoresOptions = document.getElementById('availableStoresOptions');

            populateAvailableStores(allAvailableStores, likedStores);

            storeFilterInput.addEventListener('focus', () => {
                availableStoresOptions.classList.remove('hidden');
            });

            storeFilterInput.addEventListener('blur', (event) => {
                setTimeout(() => {
                    if (!detailsModal.contains(event.relatedTarget)) {
                        availableStoresOptions.classList.add('hidden');
                    }
                }, 100);
            });

            storeFilterInput.addEventListener('input', (event) => {
                const filterText = event.target.value.toLowerCase();
                const filteredStores = allAvailableStores.filter(store => {
                    const storeName = store.StoreName || '';
                    const city = store.City || '';
                    const address = store.Address || '';
                    const brandName = store.brandName || '';
                    return (
                        storeName.toLowerCase().includes(filterText) ||
                        address.toLowerCase().includes(filterText) ||
                        city.toLowerCase().includes(filterText) ||
                        brandName.toLowerCase().includes(filterText)
                    );
                });
                populateAvailableStores(filteredStores, likedStores);
                availableStoresOptions.classList.remove('hidden');
            });
        }

        function createLikedStoreElement(store) {
            const storeId = store.StoreId || store.StoreID;
            const brandName = store.brandName || 'שם רשת לא ידוע';
            const storeName = store.StoreName || 'שם חנות לא ידוע';
            const storeCity = store.City || 'עיר לא ידועה';
            const storeAddress = store.Address && store.Address !== 'unknown' ? store.Address : 'כתובת לא ידועה';
            const hebrewBrand = hebrewBrandNames[brandName] || brandName;

            const element = document.createElement('div');
            element.className = `flex justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-gray-200`;
            element.innerHTML = `
                <div class="flex flex-col">
                    <div class="font-bold text-gray-800 text-2xl">${hebrewBrand}</div>
                    <span class="text-sm font-normal text-gray-600">${storeName}, ${storeCity}</span>
                    <span class="text-sm font-normal text-blue-600">${storeAddress}</span>
                </div>
                <div class="flex gap-2">
                    <a href="https://maps.google.com/?q=${encodeURIComponent(storeAddress + ' ' + storeCity)}" target="_blank" class="text-blue-500 transition-colors hover:text-blue-700 p-2 rounded-full hover:bg-gray-100">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                    </a>
                    <button class="remove-btn text-red-500 transition-colors hover:text-red-700 p-2 rounded-full hover:bg-gray-100" data-store-id="${storeId}" data-brand-name="${brandName}">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            `;

            element.querySelector('.remove-btn').addEventListener('click', () => {
                updateLikedSupermarket(storeId, brandName, 'remove');
            });

            return element;
        }

        function createAvailableStoreElement(store) {
            const storeId = store.StoreId || store.StoreID;
            const brandName = store.brandName || 'שם רשת לא ידוע';
            const storeName = store.StoreName || 'שם חנות לא ידוע';
            const storeCity = store.City || 'עיר לא ידועה';
            const storeAddress = store.Address && store.Address !== 'unknown' ? store.Address : 'כתובת לא ידועה';
            const hebrewBrand = hebrewBrandNames[brandName] || brandName;

            const element = document.createElement('div');
            element.className = `custom-dropdown-item`;
            element.dataset.storeId = storeId;
            element.innerHTML = `
                <div class="font-bold text-xl">${hebrewBrand}</div>
                <div class="text-sm font-normal text-gray-600">${storeName}, ${storeCity} - <span class="text-blue-600">${storeAddress}</span></div>
            `;

            element.addEventListener('click', () => {
                showStoreDetailsModal(store);
            });

            return element;
        }

        function populateAvailableStores(stores, likedStores) {
            const availableStoresOptions = document.getElementById('availableStoresOptions');
            availableStoresOptions.innerHTML = '';

            const likedStoreIds = new Set(likedStores.map(store => store.StoreId || store.StoreID));
            const filteredAndAvailable = stores.filter(store => !likedStoreIds.has(store.StoreId || store.StoreID));

            if (filteredAndAvailable.length === 0) {
                const item = document.createElement('div');
                item.className = 'custom-dropdown-item text-gray-500 cursor-default';
                item.textContent = 'אין חנויות זמינות';
                availableStoresOptions.appendChild(item);
            } else {
                filteredAndAvailable.forEach(store => {
                    availableStoresOptions.appendChild(createAvailableStoreElement(store));
                });
            }
        }

        function showStoreDetailsModal(store) {
            const storeId = store.StoreId || store.StoreID;
            const brandName = store.brandName || 'שם רשת לא ידוע';
            const storeName = store.StoreName || 'שם חנות לא ידוע';
            const storeCity = store.City || 'עיר לא ידועה';
            const storeAddress = store.Address && store.Address !== 'unknown' ? store.Address : 'כתובת לא ידועה';
            const hebrewBrand = hebrewBrandNames[brandName] || brandName;

            document.getElementById('modalStoreName').textContent = `${hebrewBrand} - ${storeName} (${storeCity})`;
            document.getElementById('modalAddress').textContent = storeAddress;
            document.getElementById('modalCity').textContent = storeCity;

            const mapContainer = document.getElementById('modal-map-container');
            if (storeAddress !== 'כתובת לא ידועה' && storeCity !== 'עיר לא ידועה') {
                mapContainer.innerHTML = `<iframe width="100%" height="100%" frameborder="0" style="border:0" src="https://maps.google.com/maps?q=${encodeURIComponent(storeAddress + ' ' + storeCity)}&hl=iw&z=14&output=embed" allowfullscreen></iframe>`;
            } else {
                mapContainer.innerHTML = '<p class="p-4 text-center text-gray-500">לא ניתן להציג מפה: כתובת לא זמינה.</p>';
            }

            addFromModalBtn.dataset.storeId = storeId;
            addFromModalBtn.dataset.brandName = brandName;
            detailsModal.classList.remove('hidden');
        }

        addFromModalBtn.addEventListener('click', () => {
            const storeId = addFromModalBtn.dataset.storeId;
            const brandName = addFromModalBtn.dataset.brandName;
            if (storeId && brandName) {
                updateLikedSupermarket(storeId, brandName, 'add');
                detailsModal.classList.add('hidden');
            }
        });


        async function sendUpdateRequest() {
            showLoading();
            const url = '/api/generalsettings/updatePrices';
            const data = { action: "manualUpdate" };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Price update request sent successfully:', result);
                    showToast('עדכון מחירים בוצע בהצלחה!');
                } else {
                    console.error('Failed to send update request:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Server response:', errorText);
                    showToast('שגיאה בעדכון מחירים.');
                }
            } catch (error) {
                console.error('An error occurred while sending the request:', error);
                showToast('שגיאה בעדכון מחירים: בעיית רשת.');
            } finally {
                hideLoading();
            }
        }
        fetchSettings();
        const updateBtn = document.getElementById('updateBtn');
        updateBtn.addEventListener('click', () => {
            sendUpdateRequest();
        });
    });
</script>

</body>
</html>
